---
title: "Alex G Census 2020 Analysis"
author: "Tim Nieuwenhuis"
date: "4/30/2020"
output: html_document
---

```{r setup, include=T}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ztable)
library(UpSetR)
library(wordcloud)
library(rworldmap)
library(mapproj)
library(wesanderson)
library(maps)

options(ztable.type = "html")
#For simulated p-values
set.seed(123)
```

Load data
```{r}
dat <- read.csv("inputs/alex_g_stats_6_19.csv", stringsAsFactors = F)
head(dat)

#make it pretty
CapStr <- function(y) {
  c <- strsplit(y, " ")[[1]]
  paste(toupper(substring(c, 1,1)), substring(c, 2),
      sep="", collapse=" ")
}
```

#Demographics questions

```{r}
#Age
ggplot(dat, aes(age)) + geom_histogram(breaks=seq(15, 45, by=1), fill = "white", color = "black")

#Race plot
race_plot <- ggplot(dat, aes(race)) + geom_bar() + coord_flip()

#gender plot
gender_plot <- ggplot(dat, aes(gender)) + geom_bar() +
  theme(axis.text.x = element_text(angle = -20, vjust = 0))                         
#trans identity plot
trans_plot <-  ggplot(dat, aes(transgender)) + geom_bar()

#orientation plot
orientation_plot <-  ggplot(dat, aes(orientation)) + geom_bar()

#polyamorous identity plot
poly_plot <-  ggplot(dat, aes(polyamorous)) + geom_bar()
```



Questions redo previous age analysis, use substraction to gain more individuals based on previous data
```{r}

```


# Make a map of the world

Preparing and loading data
```{r}


country_codes <- read.csv("inputs/countrycode.csv", stringsAsFactors = F)

#Get a count of fans per each country
world_dat <- as.data.frame(table(dat$country), stringsAsFactors = F)
 
colnames(world_dat) <- c("Country.Name", "fans")
#Join with official data
world_dat  <- left_join(country_codes, world_dat)
 
world_needed <- world_dat %>% select(fans, ISO2, ISO3, Country.Name) 

#colors
pal <- wes_palette("Zissou1", 100, type = "continuous")
 
 
#Get a higher rsolution
worldmap <- getMap(resolution = "low")

worldmap@data <- left_join(worldmap@data, world_needed)
worldmap_poly <- fortify(worldmap)
worldmap_poly <- merge(worldmap_poly, worldmap@data, by.x="id", by.y="ADMIN", all.x=T)

#Remove the US because they have to many indiiduals
worldmap_poly_nUSA <- worldmap_poly %>% filter(Country.Name != "United States")
```


##Plottin the world

Plot the whole world with the US
```{r}
#Whole world with US
ggplot() + 
  coord_map(xlim = c(-180, 180), ylim = c(-60, 75))  +
  geom_polygon(data = worldmap_poly, aes(long, lat, group = group, fill = log2(fans)),size = 0.3) +

geom_text(data=subset(worldmap@data, !is.na(SOVEREIGNT)), aes(x=LON, y=LAT,label=fans), size=1.5)   + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered"))
```

As you can see the US has to many fans and so it will get its own figure later on below is the world without the US
```{r}
ggplot() + 
  coord_map(xlim = c(-180, 180), ylim = c(-60, 75))  +
  geom_polygon(data = worldmap_poly_nUSA, aes(long, lat, group = group, fill = fans),size = 0.3) +
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered"))  +
  labs(title = "Alex G fans around the world") + theme_gray(base_size =  14)

ggsave("outputs/world_no_us.png", width = 10, height = 10)

```

Focusing on North America
```{r}
ggplot() + 
  coord_map(xlim = c(-180, 180), ylim = c(-60, 75))  +
  geom_polygon(data = worldmap_poly_nUSA, aes(long, lat, group = group, fill = fans),size = 0.3) +
  geom_text(data=subset(worldmap@data, !is.na(SOVEREIGNT)), aes(x=LON, y=LAT,label=fans), size=5) +
 coord_cartesian(xlim = c(-150, -50), ylim = c(15, 60)) +
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered"))  + theme_void( base_size = 14) +
  labs(title = "Alex G Fans Sans Americans")

ggsave("outputs/north_america.png")
```

Focusing on South America
```{r fig.height = 8, fig.width = 6, fig.align = "center"}
###South america
ggplot() + 
  coord_map(xlim = c(-180, 180), ylim = c(-60, 75))  +
  geom_polygon(data = worldmap_poly_nUSA, aes(long, lat, group = group, fill = fans), color = "black" ,size = 0.3) +

geom_text(data=subset(worldmap@data, !is.na(SOVEREIGNT)), aes(x=LON, y=LAT,label=fans), size=5)+
  coord_cartesian(xlim = c(-90, -30), ylim = c(-60, 15))  +
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered")) + theme_void( base_size = 14) +
  labs(title = "Alex G Fans in South America")
ggsave("outputs/south_america.png", height = 8, width = 7)
```


Focusing on South East Asia and Oceana
```{r fig.height = 8, fig.width = 6, fig.align = "center"}
###Oceana and south east asia
ggplot() + 
  coord_map(xlim = c(-180, 180), ylim = c(-60, 75))  +
  geom_polygon(data = worldmap_poly_nUSA, aes(long, lat, group = group, fill = fans), color = "black",size = 0.3) +

geom_text(data=subset(worldmap@data, !is.na(SOVEREIGNT)), aes(x=LON, y=LAT,label=fans), size=5)+
  coord_cartesian(xlim = c(100, 180), ylim = c(-50, 45))  +
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered"))  + theme_void( base_size = 14) +
  labs(title = "Alex G Fans in East Asian and Oceania")

ggsave("outputs/south_asia_aus.png", height = 8, width = 7)
```

Focusing on Europe
```{r fig.height = 8, fig.width = 6, fig.align = "center"}
###Europe
ggplot() + 
  coord_map(xlim = c(-180, 180), ylim = c(-60, 75))  +
  geom_polygon(data = worldmap_poly_nUSA, aes(long, lat, group = group, fill = fans), color = "black",size = 0.3) +

geom_text(data=subset(worldmap@data, !is.na(SOVEREIGNT)), aes(x=LON, y=LAT,label=(fans)), size=5)+
  coord_cartesian(xlim = c(-10, 30), ylim = c(30, 70))   + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered")) + theme_void( base_size = 14) +
  labs(title = "Alex G Fans in Europe")

ggsave("outputs/europe_current.png", height = 8, width = 7) 

```

# Make a map of the US
I used the below vignette to do this
https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html

Preparing data
```{r}
us_states <- map_data("state")
#head(us_states)

#Filter state data
state_dat <- dat %>% filter(!(state %in% c("I don't live in the states", ""))) %>% mutate(region = tolower(state))

state_df <- data.frame(table(state_dat$region),
                       colnames = "regions",
                       stringsAsFactors = F) %>%
              select(region = Var1, count = Freq)

us_states_2 <- left_join(us_states, state_df)

```

Using state census data (where did I get that?) to pull control for state population density. 
```{r}

#######
census <- read.csv("inputs/state_census.csv", stringsAsFactors = F) %>%
          mutate(region = tolower(str_replace(region, pattern = "[.]", replacement = ""))) %>% select(region, X2019)
          
census <- census %>% mutate(X2019= round(as.numeric(str_replace_all(X2019, ",", ""))))

#100000

us_states_3 <- left_join(us_states_2, census) %>% mutate(count = ifelse(is.na(count), 0, count),
                                                         adjust = round((count/X2019 * 100000), digits = 3))
```

Reading in other census data, not sure what the difference between them here is, gotta figure that out.
```{r}
center_state <- read.csv(file = "inputs/statelatlong_2.csv", stringsAsFactors = F) %>% rename(region = name, lat_center = latitude, long_center = longitude) %>%
  mutate(region = tolower(region))

us_states_3 <- left_join(us_states_3, center_state)
```

Making a blank canvas for the plots
```{r}
p <- ggplot(data = us_states_3,
            mapping = aes(x = long, y = lat,
                          group = group, fill = adjust), color = "black")
```

Plotting all of the US
```{r fig.height = 6, fig.width = 8, fig.align = "center"}
#All of US
p + geom_polygon(color = "gray90", size = 0.1) +
    coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
    geom_text(aes(long_center, lat_center, label = count))  + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered")) +
  labs(title = "Alex G Fans in the USA",fill = "Fans per 100,000 indv")
ggsave("outputs/all_us.png", height = 6, width = 8)
```

Plotting the North East
```{r fig.height = 6, fig.width = 6, fig.align = "center"}
#North East
p + geom_polygon(color = "gray90", size = 0.1) +
    coord_map(xlim = c(-80, -65), ylim = c(38,48)) +
    geom_text(aes(long_center, lat_center, label = count), size = 3.3)  + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered")) +
  labs(title = "Alex G Fans in the North East",fill = "Fans per 100,000 indv")
ggsave("outputs/NE_us.png", height = 8, width = 8)
```

Plotting the South
```{r fig.height = 5, fig.width = 8, fig.align = "center"}
#The south
p + geom_polygon(color = "gray90", size = 0.1) +
    coord_map(xlim = c(-110, -65), ylim = c(25,40)) +
    geom_text(aes(long_center, lat_center, label = count), size = 3.3)  + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered"))+
  labs(title = "Alex G Fans in the South",fill = "Fans per 100,000 indv")
ggsave("outputs/south_us.png", height = 8, width = 12)
```
Plotting the Midwest
```{r fig.height = 5, fig.width = 7.5, fig.align = "center"}
#The Mid West
p + geom_polygon(color = "gray90", size = 0.1) +
    coord_map(xlim = c(-114, -80), ylim = c(32,49)) +
    geom_text(aes(long_center, lat_center, label = count))  + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered"))+
  labs(title = "Alex G Fans in the Mid West",fill = "Fans per 100,000 indv")
ggsave("outputs/midwest_us.png", height = 8, width = 9)
```
Plotting the West
```{r, fig.height = 9, fig.width = 6, fig.align = "center"}
#The west
p + geom_polygon(color = "gray90", size = 0.1) +
    coord_map(xlim = c(-125, -110), ylim = c(30,49)) +
    geom_text(aes(long_center, lat_center, label = count))  + 
  scale_fill_gradientn(colours = c("cyan3", "gold", "orangered")) +
  labs(title = "Alex G Fans in the West",fill = "Fans per 100,000 indv") + theme_grey(base_size = 14)
ggsave("outputs/west_us.png", height = 9, width = 7)


```

# 666posting Political Compasss (spice alert)

Preparing the data
```{r}

#I remove one fill in the blank because... yeah
poltical_dat <- select(dat,left_right, lib_auth, gender, age) %>% drop_na() %>% mutate(gender = ifelse(gender =="There are only 2 genders", "Prefer not to say", gender))


#Get the medians and means of the compass
med_LR <- median(poltical_dat$left_right)
med_LA <- median(poltical_dat$lib_auth)
mean_LR <- mean(poltical_dat$left_right)
mean_LA <- mean(poltical_dat$lib_auth)
```

First political compass using gender as a variable, I could probably make this a base plot and use the base to change the other ones.
```{r}
ggplot(poltical_dat) +
           geom_rect(aes(xmin = 5, xmax= 10,ymin = 0, ymax=5), fill = "yellow", alpha = 0.005) +
           geom_rect(aes(xmin = 0, xmax= 5,ymin = 0, ymax=5), fill = "green", alpha = 0.005) +
           geom_rect(aes(xmin = 5, xmax= 10,ymin = 5, ymax=10), fill = "blue", alpha = 0.005) +
           geom_rect(aes(xmin = 0, xmax= 5,ymin = 5, ymax=10), fill = "red", alpha = 0.005) + 
          geom_jitter(aes(x = left_right, y = lib_auth, shape = gender), width =.5, height =.5, alpha = .5, ) +
          #Adding median and mean
          geom_point(aes(x=med_LR, y=med_LA), colour="blue", shape = 9, size =2) +
          geom_point(aes(x=mean_LR, y=mean_LA), colour="red", shape = 9, size =2) +
          #Add the dotplot annotation
          geom_point(aes(x=8, y=3), colour="blue", shape = 9, size =3) +
          geom_point(aes(x=8, y=1.5), colour="red", shape = 9, size =3) +
  #Add annotations to the compass
          labs(title = "666posting Political Compass", subtitle = paste0("N = ", nrow(poltical_dat))) + 
   ylab("libertarian to authoritarian") +
               xlab("left to right") +
              coord_fixed() + annotate("text", x = c(2.5, 2.5, 7.5, 7.5),
                                       y = c(10.5, -.5, 10.5, -.5),
                                       label = c("Auth Left", "Lib Left", "Auth Right", "Lib Right"), size =5) +
                                annotate("text", x = c(8, 8),
                                       y = c(2, 3.5),
                                       label = c("Mean", "Median"), size =4) + 
                                       theme_void(base_size = 14)
ggsave("outputs/political_compass_gender.png")
```

Poltical compass with age as a variable
```{r}
#Age
ggplot(poltical_dat) +
           
           geom_rect(aes(xmin = 5, xmax= 10,ymin = 0, ymax=5), fill = "yellow", alpha = 0.005) +
           geom_rect(aes(xmin = 0, xmax= 5,ymin = 0, ymax=5), fill = "green", alpha = 0.005) +
           geom_rect(aes(xmin = 5, xmax= 10,ymin = 5, ymax=10), fill = "blue", alpha = 0.005) +
           geom_rect(aes(xmin = 0, xmax= 5,ymin = 5, ymax=10), fill = "red", alpha = 0.005) + 
          geom_jitter(aes(x = left_right, y = lib_auth, color = age), width =.5, height =.5 ) +
          #Adding median and mean
          geom_point(aes(x=med_LR, y=med_LA), colour="blue", shape = 9, size =2) +
          geom_point(aes(x=mean_LR, y=mean_LA), colour="red", shape = 9, size =2) +
          labs(title = "666posting Political Compass", subtitle = paste0("N = ", nrow(poltical_dat))) + 
   ylab("libertarian to authoritarian") +
               xlab("left to right") +
              coord_fixed() + annotate("text", x = c(2.5, 2.5, 7.5, 7.5),
                                       y = c(10.5, -.5, 10.5, -.5),
                                       label = c("Auth Left", "Lib Left", "Auth Right", "Lib Right"), size =5) + 
                                       scale_colour_gradient(low = "black", high = "white", na.value = NA) +
                                       theme_void()

```

Gender compass again, but without the jitter, instead using the size of the points to determine density. 
```{r}
#Second version change the size of points based on how many points there are there
poltical_dat_2 <- rbind(poltical_dat, c(9, 8))

pol_count <- as.data.frame(table(poltical_dat_2$left_right, poltical_dat_2$lib_auth))
pol_count <- pol_count %>% mutate(Freq = ifelse((Var1 == "9" & Var2 == "8"), Freq - 1, Freq))

colnames(pol_count)[1:2] <- c("left_right", "lib_auth")
pol_count$left_right <- as.integer(as.character(pol_count$left_right))
pol_count$lib_auth <- as.integer(as.character(pol_count$lib_auth))

pol_count <- filter(pol_count, Freq != 0)

ggplot(pol_count) +
          #  
            geom_rect(aes(xmin = 5, xmax= 10,ymin = 0, ymax=5), fill = "yellow", alpha = 0.02) +
            geom_rect(aes(xmin = 0, xmax= 5,ymin = 0, ymax=5), fill = "green", alpha = 0.02) +
            geom_rect(aes(xmin = 5, xmax= 10,ymin = 5, ymax=10), fill = "blue", alpha = 0.02) +
            geom_rect(aes(xmin = 0, xmax= 5,ymin = 5, ymax=10), fill = "red", alpha = 0.02) + 
           geom_point(aes(x = left_right, y = lib_auth, size= Freq)) +
           #Adding median and mean
           geom_point(aes(x=med_LR, y=med_LA), colour="white", shape = 9, size =3) +
           geom_point(aes(x=mean_LR, y=mean_LA), colour="red", shape = 9, size =3) +
         #Add the dotplot annotation
          geom_point(aes(x=8, y=3), colour="white", shape = 9, size =4) +
          geom_point(aes(x=8, y=1.5), colour="red", shape = 9, size =4) +
          labs(title = "666posting Political Compass", subtitle = paste0("N = ", nrow(poltical_dat))) + 
   ylab("Libertarian to Authoritarian") +
               xlab("Left to Right") +
              # scale_x_continuous(breaks = c(0:10))+
               #scale_y_continuous(breaks = c(0:10)) +
              scale_x_continuous(breaks = c(0,2,4,6,8,10))+
               scale_y_continuous(breaks = c(0,2,4,6,8,10)) +
               scale_size_continuous(breaks = c(1, 3, 6, 9, 13, 15, 17),  range = c(2.5,8)) + 
                                annotate("text", x = c(8, 8),
                                       y = c(2, 3.5),
                                       label = c("Mean", "Median"), size =4) +
              coord_fixed() + theme_grey(base_size = 14)
ggsave("outputs/political_compass_exact.png")



```

# Musicians in 666posting

Prepare the data and make a melted version of the datarframe
```{r}
band_dat <- dat %>% mutate(id = row_number(), 
                           instruments = gsub("Music Software \\(eg. Ableton, FL studio\\)",
                                              "Music Software",
                                              instruments),
                           instruments = str_replace_all(instruments,
                                                         "a little bit of chinese flute",
                                                         "Chinese Flute")) %>% 
                     filter(!(str_detect(instruments, "anymore")) |
                              instruments != "Nope" |
                              str_detect(instruments, "not")) %>%
                    select(id, instruments, in_band) 

band_dat_melt <- band_dat %>%
  mutate(instrument = (str_split(instruments, ","))) %>%
  unnest(cols = instrument) %>%
  mutate(instrument =(str_trim(instrument, "both"))) %>%
  filter(!(instrument %in% c("Used to","but not anymore", "", "Nope")))

#Check data looks okay
unique(band_dat_melt$instrument)

#Make dataframe giving a 1 or 0 to each person based on if they play the instrument or not, 1 is TRUE and 0 is false
instr_dat <- (as.data.frame.matrix(table(band_dat_melt$id, band_dat_melt$instrument)))
```


Generate general summaries
```{r}
#General stats
sum_instr <- as.data.frame(table(band_dat_melt$instrument),
                           stringsAsFactors = F) %>%
              mutate(Var1 = str_to_title(Var1))
```

Plot of instruments played in 666posting
```{r}
ggplot(sum_instr, aes(x = reorder(Var1, -Freq), y = Freq, fill = Var1)) +
  geom_bar(stat= "identity") +
  labs(title = "Instruments played in this group",
       subtitle = paste0("N = ", length(unique(band_dat_melt$id)))) +
  ylab(label = "Count") +
  xlab(label = "Instruments") + 
    theme_classic(base_size = 16) +
 theme(axis.text.x = element_text(angle=85, hjust=1, vjust = 1),
       legend.position = "None") +
  geom_text(aes(label=Freq),
            position=position_dodge(width=0.9),
            vjust=-0.25)

ggsave("outputs/instrument_summary.png", width = 8, height = 8)
```

Prepare data to be Upset plots instead of venn diagrams
```{r}
#Make Instrument strings look like titles
colnames(instr_dat) <- str_to_title(colnames(instr_dat))

instru = 1
instrument_list <- list()
#Probably should change this to a lapply, but we use this loop to generate a list of ids that play a given instrument
for (instru in 1:ncol(instr_dat)) {
   instrument_list[[colnames(instr_dat)[instru]]] <- (1:nrow(instr_dat))[instr_dat[,instru] == 1]
}
```

First Upset Plot
```{r}
plot_up <- upset(fromList(instrument_list),
                 order.by = "freq",
                 nsets = 6,
                 #point.size = 4,
                 #line.size = 1.8,
                 #text.scale=c(4, 2, 2, 2, 2, 2),
                 mainbar.y.label = "Instrument Intersections",
                 sets.x.label = "People Per Instrument"
                 )

plot_up
```

Second Instrument plot, it contains more instruments
```{r  fig.height = 6, fig.width = 10, fig.align = "center"}
plot_ups <- upset(fromList(instrument_list),
                  order.by = "freq",
                  nsets = 30,
                  #point.size = 2.8,
                  #line.size = 1,
                  #text.scale=c(4, 2, 2, 2, 2, 2),
                  mainbar.y.label = "Instrument Intersections",
                  sets.x.label = "People Per Instrument"
                  )

plot_ups
```

Save them via graphical device
```{r}
png("outputs/instrument_plot.png", width = 800, height = 800)
plot_ups
dev.off()

png("outputs/instrument_5_plot.png", width = 800, height = 800)
plot_up
dev.off()


```
# Favorite Music/Musicians
## Clean up data


Select out and clean musicians
```{r}
musician_dat <- dat %>%
        select(Timestamp, favorite_musician, sec_musician = second_favorite_musician, music_genre)  %>%
        #Mutate all names to lower first and trim whitesppace
        mutate(favorite_musician = str_trim(tolower(favorite_musician)),
               sec_musician = str_trim(tolower(sec_musician)),
        #Fix all spelling of musician names that stand out to me
               favorite_musician = case_when(
                 favorite_musician == "elliot smith" ~ "elliott smith",
                 str_detect(favorite_musician, "suicide") ~ "teen suicide",
                 str_detect(favorite_musician, "title") ~ "title fight",
                 T ~ favorite_musician),
               sec_musician = case_when(
                 favorite_musician == "elliot smith" ~ "elliott smith",
                 str_detect(favorite_musician, "suicide") ~ "teen suicide",
                 T ~ sec_musician
               ),
        #Clean up alex g titles to new/old official spelling and string to title for presentation
               favorite_musician = ifelse(favorite_musician == "(sandy) alex g", "Alex G", str_to_title(favorite_musician)),
               sec_musician = ifelse(sec_musician == "(sandy) alex g", "Alex G", str_to_title(sec_musician))) %>%
        #clean all blanks
        filter(favorite_musician != "", sec_musician != "", music_genre != "")

fave_musician <- as.data.frame(table(musician_dat$favorite_musician), stringsAsFactors = F)
sec_musician <- as.data.frame(table(musician_dat$sec_musician), stringsAsFactors = F)
```


Color on number of fans
```{r}

color_artist <- brewer.pal(n = 3, name = "Dark2")

fave_musician <- fave_musician %>% mutate(color_fan = case_when(
                            Freq >= 29 ~ color_artist[1],
                            Freq > 1 ~ color_artist[2],
                            T ~ "black"
                          ))


sec_musician <- sec_musician %>% mutate(color_fan = case_when(
                            Freq >= 29 ~ color_artist[1],
                            Freq > 1 ~ color_artist[2],
                            T ~ "black"
                          ))


```

Word cloud For Favorite musician
```{r}
#Word cloud for markdown

wordcloud(words = fave_musician$Var1, freq = fave_musician$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.35, 
                            colors=fave_musician$color_fan, ordered.colors = T
                            )
#Print word cloud
png("outputs/favorite_musician.png", units="in", width=5, height=5, res=300)
wordcloud(words = fave_musician$Var1, freq = fave_musician$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.35, 
                            colors=fave_musician$color_fan, ordered.colors = T
                            )
dev.off()
```

Word cloud For Second Favorite musician
```{r}
#Word cloud for markdown

wordcloud(words = sec_musician$Var1, freq = sec_musician$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.35, 
                            colors=sec_musician$color_fan, ordered.colors = T
                            )
#Print word cloud
png("outputs/second_musician.png", units="in", width=5, height=5, res=300)
wordcloud(words = sec_musician$Var1, freq = sec_musician$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.35, 
                            colors=sec_musician$color_fan, ordered.colors = T
                            )
dev.off()
```


Clean up data for favorite Genres

```{r}
genre_dat <- musician_dat %>%
                  mutate(music_genre = str_replace(str_to_lower(str_trim(music_genre)), "-", " ")) %>%
                  filter(music_genre != "") %>%
                  mutate(music_genre = case_when(
                    music_genre %in% "imdie rock" ~ "indie rock",
                    music_genre %in% "lofi / 'indie rock' i guess lol" ~ "lofi",
                    music_genre %in% "indite rock" ~ "indie rock",
                    music_genre %in% "indie rock / folk / jazz" ~ "jazz",
                    music_genre %in% "indie rock, punk, alternative." ~ "punk",
                    music_genre %in% "shoegaze/indie rock" ~ "shoegaze",
                    T ~ music_genre
                    ),
                    music_genre = str_to_title(music_genre))

genre_table <- data.frame(table(genre_dat$music_genre), stringsAsFactors = F)


genre_table <- genre_table %>% mutate(color_fan = case_when(
                            Freq >= 30 ~ color_artist[1],
                            Freq > 1 ~ color_artist[2],
                            T ~ "black"
                          ))


```

Word cloud For Favorite Genre
```{r}
#Word cloud for markdown

wordcloud(words = genre_table$Var1, freq = genre_table$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.30, 
                            colors=genre_table$color_fan, ordered.colors = T
                            )
#Print word cloud
png("outputs/favorite_genre.png", units="in", width=5, height=5, res=300)
wordcloud(words = genre_table$Var1, freq = genre_table$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.30, 
                            colors=genre_table$color_fan, ordered.colors = T
                            )
dev.off()
```



# Alex G Music 

## Favorite Album
 Prepare data
```{r}
##Filter down to Albums and songs to make an object usable in the next two chuncks
songs_dat <- dat%>% select(Timestamp, favorite_song, favorite_album, unreleased_album)
```

Favorite Album Plot
```{r}
ggplot(songs_dat, aes(x = forcats::fct_infreq(favorite_album)),
      fill = forcats::fct_infreq(favorite_album)) +
      geom_bar(aes(fill = forcats::fct_infreq(favorite_album))) +
      scale_fill_manual(
      values = c("deepskyblue1",
                 "royalblue4",
                 "springgreen4",
                 "deeppink1",
                 "red3",
                 "darkorchid4",
                 "black",
                 "grey68",
                 "yellow3"
                )
            ) +
    theme_grey(base_size = 14)  +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.title = element_blank()) +
    labs(title = "Favorite Alex G Album",
         subtitle = paste0("N = ",nrow(songs_dat)))
ggsave("outputs/favorite_album.png", height = 7, width = 7)
```

Favorite Unreleased Album/Compilation
```{r}
ggplot(songs_dat, aes(x = forcats::fct_infreq(unreleased_album))) +
  geom_bar(aes(fill = forcats::fct_infreq(unreleased_album))) +
  theme_grey(base_size = 14)  +
   theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.title = element_blank()) +
    labs(title = "Favorite Alex G Fan Compilation",
         subtitle = paste0("N = ",nrow(songs_dat)))

#Save it
ggsave("outputs/favorite_fancomp.png", height = 7, width = 7)
```

Prepare song data for plotting
```{r}
#Read in songs for albums, A CSV I made.
album_songs <- read.csv("inputs/alex_g_album_songs.csv", stringsAsFactors = F)
album_songs <- album_songs %>% mutate_all(str_to_title)


#Fixing various naming issues
songs_dat <- songs_dat %>% mutate(favorite_song = case_when(
                                    str_detect(favorite_song, "Bonus") ~ "Good",
                                    str_detect(favorite_song, "House") ~ "Sugarhouse",
                                    TRUE ~ favorite_song
                                  ),
                                  favorite_song = str_to_title(str_trim(favorite_song, side = "both")))

#Get count of songs
songs_only <- as.data.frame(table(songs_dat$favorite_song), stringsAsFactors = F)


#Color songs based on album source
songs_only <- songs_only %>% mutate(color = case_when(
                                    Var1 %in% album_songs$house_of_sugar ~ "darkorchid4",
                                    Var1 %in% album_songs$rocket_ ~ "red3",
                                    Var1 %in% album_songs$beach_music ~ "royalblue4",
                                    Var1 %in% album_songs$dsu ~ "springgreen4",
                                    Var1 %in% album_songs$trick ~ "deepskyblue1",
                                    Var1 %in% album_songs$rules ~ "black",
                                    Var1 %in% album_songs$easy ~ "lightseagreen",
                                    Var1 %in% album_songs$race ~ "deeppink1",
                                    Var1 %in% album_songs$winner ~ "yellow4",
                                    TRUE ~ "gray34"
                                  ))

#Clean up data
songs_clean <- songs_only %>%
  arrange(desc(Freq)) %>%
  filter(Var1 != "")


```

Word Cloud of Favorite Alex G Songs

(change to songs clean eventually)
```{r}
#Word cloud for markdown

wordcloud(words = songs_only$Var1, freq = songs_only$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.35, 
                            colors=songs_only$color, ordered.colors = T)
#Print word cloud
png("outputs/favorite_song_cloud.png", units="in", width=5, height=5, res=300)
wordcloud(words = songs_only$Var1, freq = songs_only$Freq, min.freq = 1,
                            max.words=200, random.order=FALSE, rot.per=0.35, 
                            colors=songs_only$color, ordered.colors = T)
dev.off()
```

Histogram of top songs
```{r}
top_ten_songs <- head(songs_clean, 10)

ggplot(top_ten_songs, aes(x = reorder(Var1, -Freq), Freq)) +
  geom_col(fill = top_ten_songs$color) +
  labs(
    title = "Top 10 Favorite Alex G Songs",
    subtitle = paste("Total N =", sum(songs_clean$Freq), "; In graph N =", sum(top_ten_songs$Freq))
  ) + ylab("count") +
  theme_grey(base_size = 14)  +
  theme(axis.title.x=element_blank(),
                           axis.text.x = element_text(angle = 90, hjust = 0))
ggsave("outputs/top_10_songs.png", height = 7, width = 7)
```

Analyze
```{r}
### Make chi-square analysis
songs_dat_test <- songs_dat %>% mutate(favorite_album_csv = case_when(
  favorite_album %in% "Rocket" ~ "rocket_",
  TRUE ~ str_replace_all(str_to_lower(favorite_album), " ", "_")),
  #I don't know if there is a better way to do below, because I can't use favorite_album_csv to subset
  fav_song_fav_album = case_when(
    favorite_song %in% album_songs$house_of_sugar & favorite_album_csv == "house_of_sugar" ~ T,
    favorite_song %in% album_songs$rocket_ & favorite_album_csv == "rocket_" ~ T,
    favorite_song %in% album_songs$beach_music & favorite_album_csv == "beach_music" ~ T,
    favorite_song %in% album_songs$dsu & favorite_album_csv == "dsu" ~ T,
    favorite_song %in% album_songs$trick & favorite_album_csv == "trick" ~ T,
    favorite_song %in% album_songs$rules & favorite_album_csv == "rules" ~ T,
    favorite_song %in% album_songs$easy & favorite_album_csv == "easy" ~ T,
    favorite_song %in% album_songs$winner & favorite_album_csv == "winner" ~ T,
    favorite_song %in% album_songs$race & favorite_album_csv == "race" ~ T,
    T ~ F
    )
  ) %>% filter(favorite_song %in% as.vector(unlist(album_songs)), favorite_song != "")




table(songs_dat_test$fav_song_fav_album)

favorite_song_chi <- chisq.test(table(songs_dat_test$fav_song_fav_album))

favorite_song_chi

#
```
It is more likely that you will not have your favorite song in your favorite album

# Personality Questions

```{r}
##Pull personality data
pers_dat <- dat %>% select(Timestamp, mbti, hp_house, sign, weed_use, alc_use) 


#Figure size
hght <- 7.29
wdth <- 4.5
```


## Myers Briggs

Not really sure what the best question to ask here is besides the distribution and how the distribution differs from the normal world. Data pulled from [here](https://www.myersbriggs.org/my-mbti-personality-type/my-mbti-results/how-frequent-is-my-type.htm)
```{r}

#Reduced the the percentaghe of ISFJ ESFJ and ISTJ because everywhere I look the percent is over 100
mb_types = c( .137,
              .122,
              .115,
              .088,
              .087,
              .085,
              .081,
              .054,
              .044,
              .043,
              .033,
              .032,
              .025,
              .021,
              .018,
              .015)
  
mb_names = c("ISFJ",	              
            "ESFJ",	             	
            "ISTJ",	             	
            "ISFP",	          	
            "ESTJ",	          	
            "ESFP",	          	
            "ENFP",	         	
            "ISTP",	      	
            "INFP",	     	
            "ESTP",	     	
            "INTP",	    	
            "ENTP",	    	
            "ENFJ",	    
            "INTJ",	   
            "ENTJ",
            "INFJ")

names(mb_types) = mb_names

mb_df <- as.data.frame(mb_types) %>%
  rownames_to_column(var = "mbtis") %>%
  rename(mbti_percent = mb_types) %>%
  mutate(IE = ifelse(str_detect(mbtis, "I"), "I", "E"),
         SN = ifelse(str_detect(mbtis, "S"), "S", "N"),
         FT = ifelse(str_detect(mbtis, "F"), "F", "T"),
         JP = ifelse(str_detect(mbtis, "J"), "J", "P"))

#Better way to do this?
EI <- mb_df %>% group_by(IE) %>% summarise(sum(mbti_percent))
SN <- mb_df %>% group_by(SN) %>% summarise(sum(mbti_percent))
FT <- mb_df %>% group_by(FT) %>% summarise(sum(mbti_percent))
JP <- mb_df %>% group_by(JP) %>% summarise(sum(mbti_percent))
colnames(EI) <- c("type", "percent type")
colnames(SN) <- c("type", "percent type")
colnames(FT) <- c("type", "percent type")
colnames(JP) <- c("type", "percent type")


letter_df <- rbind(EI,SN,FT,JP)

category <- factor(c("E or I", "E or I", "N or S", "N or S", "F or T", "F or T", "J or P", "J or P"),
                   c("E or I", "N or S", "F or T", "J or P"))

letter_df <-  cbind(letter_df, category)


```

General population plots Myer-Briggs Type
```{r}

#Factor levels to maintain look in plot
mb_df$mbtis <- factor(mb_df$mbtis, levels = mb_names)

ggplot(mb_df,
       aes(x = mbtis,
           y = mbti_percent,
           fill = mbtis)) +
  geom_col(color = "black") + 
  scale_y_continuous(labels = scales::percent) +
  ylab("Myer-Briggs Type Percent") +
  xlab("Myer-Briggs Type") +
  labs(title = "Population Myer-Briggs Types",
       subtitle = "N Unknown, from studies between 1972-2002 (pls update website)") +


ggsave(filename = "outputs/myer-brigg-gen-pop.png", width = hght, height = wdth)

```

General Population Single Type
```{r}

letter_df$type <- factor(letter_df$type, c("E", "I", "N", "S", "F", "T", "J", "P"))

ggplot(letter_df, aes(x = category, y = `percent type`, fill = type)) +
  geom_bar(position = "stack", stat = "Identity") +
  scale_fill_brewer(palette = "Set1", name = "Discrete Types", labels = c("Extrovert", "Introvert",
                                                          "Intuitives", "Sensors",
                                                          "Feeling", "Thinking",
                                                          "Judging", "Percieving"
                                                          )) +
  labs(title = "Population Myer-Briggs Single Letter Types",
       subtitle = "N Unknown, from studies between 1972-2002")

ggsave(filename = "outputs/myer-brigg-lett-gen-pop.png", width = hght, height = wdth)
```

Same analysis on Alex G

Prepare data
```{r}
##Alex Data

mbti_dat <- as.data.frame(table(pers_dat$mbti), stringsAsFactors = F) %>%
                  filter(!(Var1 %in% c("",
                                       "Prefer not to answer",
                                       "I don't know"))) %>%
                  rename(mbtis = Var1, count = Freq) %>%
                  mutate(mbti_percent = count/sum(count)) 


#They're missing data because of people gotta fill in some blanks
missing_dat <- data.frame(as.character(mb_df$mbtis[!(mb_df$mbtis %in% mbti_dat$mbtis)]),
                          rep(0, length(as.character(mb_df$mbtis[!(mb_df$mbtis %in% mbti_dat$mbtis)]))),
                          rep(0, length(as.character(mb_df$mbtis[!(mb_df$mbtis %in% mbti_dat$mbtis)]))))

colnames(missing_dat) <- c("mbtis", "count", "mbti_percent")

mbti_dat <- rbind(mbti_dat, missing_dat)

mbti_dat$mbtis <- factor(mbti_dat$mbtis, levels = mb_names)

```

Single Letter Myer-Briggs Data
```{r}
mbti_dat <- mbti_dat %>%
  mutate(IE = ifelse(str_detect(mbtis, "I"), "I", "E"),
         SN = ifelse(str_detect(mbtis, "S"), "S", "N"),
         FT = ifelse(str_detect(mbtis, "F"), "F", "T"),
         JP = ifelse(str_detect(mbtis, "J"), "J", "P"))


#Better way to do this?
EI_g <- mbti_dat %>% group_by(IE) %>% summarise(sum(count),sum(mbti_percent))
SN_g <- mbti_dat %>% group_by(SN) %>% summarise(sum(count),sum(mbti_percent))
FT_g <- mbti_dat %>% group_by(FT) %>% summarise(sum(count),sum(mbti_percent))
JP_g <- mbti_dat %>% group_by(JP) %>% summarise(sum(count),sum(mbti_percent))
colnames(EI_g) <- c("type", "count type", "percent type")
colnames(SN_g) <- c("type", "count type", "percent type")
colnames(FT_g) <- c("type", "count type", "percent type")
colnames(JP_g) <- c("type", "count type", "percent type")


letter_df_g <- rbind(EI_g,SN_g,FT_g,JP_g)

category <- factor(c("E or I", "E or I", "N or S", "N or S", "F or T", "F or T", "J or P", "J or P"),
                   c("E or I", "N or S", "F or T", "J or P"))

letter_df_g <-  cbind(letter_df_g, category)

```


Run the Chi-square analysis against general population probabilities
```{r}

##Running the chi-square 

mbti_dat$mbtis == mb_df$mbtis

mbti_dat <- mbti_dat[match(mb_df$mbtis, mbti_dat$mbtis),]

mbti_dat$mbtis == mb_df$mbtis

mbti_chisq <- chisq.test(mbti_dat$count, p = mb_df$mbti_percent, simulate.p.value = T)


#Can't lump all letters so here we go slow again
EI_chisq <- chisq.test(letter_df_g$`count type`[1:2],
                       p = letter_df$`percent type`[1:2],
                       simulate.p.value = T)

NS_chisq <- chisq.test(letter_df_g$`count type`[3:4],
                       p = letter_df$`percent type`[3:4],
                       simulate.p.value = T)

FT_chisq <- chisq.test(letter_df_g$`count type`[5:6],
                       p = letter_df$`percent type`[5:6],
                       simulate.p.value = T)

JP_chisq <- chisq.test(letter_df_g$`count type`[7:8],
                       p = letter_df$`percent type`[7:8],
                       simulate.p.value = T)

pvals_lett <- format.pval(c(EI_chisq$p.value, NS_chisq$p.value, FT_chisq$p.value, JP_chisq$p.value), 3)
```

Plotting for general types
```{r}

##Plotting the data
ggplot(mbti_dat,
       aes(x = mbtis,
           y = count,
           fill = mbtis)) +
  geom_col(color = "black") +
  xlab("Myersâ€“Briggs Type") +
  ylab("Count")  +
  labs(title = "666posting Myer-Briggs Types",
       subtitle = paste0("N = ",
                         sum(mbti_dat$count),
                         " ; Chi-Square compared to population p-value = ",
                         format.pval(mbti_chisq$p.value, digits = 3)))

ggsave(filename = "outputs/myer-brigg-666.png", width = hght, height = wdth)


```

Plotting for single letters
```{r}


letter_df_g$type <- factor(letter_df_g$type, c("E", "I", "N", "S", "F", "T", "J", "P"))

ggplot(letter_df_g, aes(x = category, y = `percent type`, fill = type)) +
  geom_bar(position = "stack", stat = "Identity") +
  scale_fill_brewer(palette = "Set1", name = "Discrete Types",
                    labels = c("Extrovert", "Introvert",
                                "Intuitives", "Sensors",
                                "Feeling", "Thinking",
                                "Judging", "Percieving"
                                                          )) +
  labs(title = "Population Myer-Briggs Single Letter Types",
       subtitle = paste("P-values per letter group in respective order:", paste(pvals_lett, collapse = ' ; ')))

ggsave(filename = "outputs/myer-brigg-lett-666.png", width = hght, height = wdth)
```


## Birthday/Zodiacs

Pulling public data to make a fair general population example and then preparing it
```{r}
us_birth <- read.csv(
  "https://raw.githubusercontent.com/fivethirtyeight/data/master/births/US_births_2000-2014_SSA.csv")

all_births = sum(us_birth$births)

us_birth_sum <- us_birth %>%
  mutate(sign = case_when(
  (month == 1 & date_of_month >= 21) | (month == 2 & date_of_month <= 18) ~ "Aquarius",
  (month == 2 & date_of_month >= 19) | (month == 3 & date_of_month <= 20) ~ "Pisces",
  (month == 3 & date_of_month >= 21) | (month == 4 & date_of_month <= 19) ~ "Aries",
  (month == 4 & date_of_month >= 20) | (month == 5 & date_of_month <= 20) ~ "Taurus",
  (month == 5 & date_of_month >= 21) | (month == 6 & date_of_month <= 20) ~ "Gemini",
  (month == 6 & date_of_month >= 21) | (month == 7 & date_of_month <= 22) ~ "Cancer",
  (month == 7 & date_of_month >= 23) | (month == 8 & date_of_month <= 22) ~ "Leo",
  (month == 8 & date_of_month >= 23) | (month == 9 & date_of_month <= 22) ~ "Virgo",
  (month == 9 & date_of_month >= 23) | (month == 10 & date_of_month <= 22) ~ "Libra",
  (month == 10 & date_of_month >= 23) | (month == 11 & date_of_month <= 21) ~ "Scorpio",
  (month == 11 & date_of_month >= 22) | (month == 12 & date_of_month <= 21) ~ "Sagittarius",
  (month == 12 & date_of_month >= 22) | (month == 1 & date_of_month <= 21) ~ "Capricorn"
  
)) %>% group_by(sign) %>%
  summarise(total_sign = sum(births)) %>%
  mutate(element = case_when(
    sign %in% c("Aries", "Leo", "Sagittarius") ~ "Fire",
    sign %in% c("Gemini", "Libra", "Aquarius") ~ "Air",
    sign %in% c("Taurus", "Virgo", "Capricorn") ~ "Earth",
    sign %in% c("Cancer", "Scorpio", "Pisces") ~ "Water"
  ),
  sign_percent = (total_sign/sum(us_birth$births)))
```


Making both colors and general population plots for zodiac signs
```{r}

#Make element colors
elem_cols = c("whitesmoke", "forestgreen", "firebrick3","deepskyblue4")

##All signs of population
ggplot(us_birth_sum, aes(x = sign, y = sign_percent, fill = element)) +
  geom_col(color = "black") +
  scale_fill_manual(values = elem_cols) + 
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("Percent") +
  xlab("Sign") +
  labs(title = "General Population Signs (births 2000-2014)",
       subtitle = paste0("N = ",
                         format(sum(us_birth_sum$total_sign),
                                big.mark = ",",
                                scientific = F)))

ggsave(filename = "outputs/horo-signs-gen-pop.png", width = hght, height = wdth)

```


Also zodiac elements
```{r}

#Element info
element_summ <- us_birth_sum %>%
                  group_by(element) %>%
                  summarise(count = sum(total_sign)) %>%
                  mutate(element_percent = count/sum(count))

#Element plot
ggplot(element_summ, aes(x = element, y = element_percent, fill = element)) +
  geom_col(color = "black") +
  scale_fill_manual(values = elem_cols) + 
  scale_y_continuous(labels = scales::percent) +
  ylab("Percent") + 
  xlab("Elements") +
  labs(title = "General Population Sign Elements (births 2000-2014)",
       subtitle = paste0("N = ",
                         format(sum(element_summ$count),
                                big.mark = ",",
                                scientific = F)))

ggsave(filename = "outputs/horo-elements-gen-pop.png", width = hght, height = wdth)
```


Preparing the Alex G data for the analysis above
```{r}
#####Now for the Alex G group -----
#Make Zodiac table
g_Zodiac <- as.data.frame(table(pers_dat$sign), stringsAsFactors = F) %>%
                  filter(!(Var1 %in% c("", "Prefer not to answer"))) %>%
                  rename(sign = Var1, count = Freq) %>%
                  mutate(sign_percent = count/sum(count)) 

#Add sign elements
g_Zodiac <- g_Zodiac %>%
                mutate(element = case_when(
                  sign %in% c("Aries", "Leo", "Sagittarius") ~ "Fire",
                  sign %in% c("Gemini", "Libra", "Aquarius") ~ "Air",
                  sign %in% c("Taurus", "Virgo", "Capricorn") ~ "Earth",
                  sign %in% c("Cancer", "Scorpio", "Pisces") ~ "Water"
                  )
                )

#Seperate element df
g_element <- g_Zodiac %>%
                  group_by(element) %>%
                  summarise(count = sum(count)) %>%
                  mutate(element_percent = count/sum(count))
```

Chi-square analysis against normal population probabilities
```{r}

##Chi-squares
#Make sure in correct order, should all be TRUE
g_Zodiac$sign == us_birth_sum$sign

sign_chisq <- chisq.test(g_Zodiac$count, p = us_birth_sum$sign_percent)
#Not sig according to probabilities 

#Elements
g_element$element == element_summ$element

element_chisq <- chisq.test(g_element$count, p = element_summ$element_percent)
```

Basic Alex G zodiac sign plot
```{r}
#Alex G Zodiac plot
ggplot(g_Zodiac, aes(x = sign, y = sign_percent, fill = element)) +
  geom_col(color = "black") + 
  scale_fill_manual(values = elem_cols) +
  scale_y_continuous(labels = scales::percent) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  ylab("Percent") +
  xlab("Sign") +
  labs(title = "666posting Zodiac Signs",
       subtitle = paste0("N = ",
                         sum(g_Zodiac$count),
                         " ; Chi-Square compared to population p-value = ",
                         format.pval(sign_chisq$p.value, digits = 3)))

ggsave(filename = "outputs/horo-signs-666.png", width = hght, height = wdth)
```

Plotting the zodiac elements of the Alex G data
```{r}
#Alex G element plot
ggplot(g_element, aes(x = element, y = element_percent, fill = element)) +
  geom_col(color = "black") +
  scale_fill_manual(values = elem_cols) + 
  scale_y_continuous(labels = scales::percent) +
  ylab("Percent") +
  xlab("Elements") +
  labs(title = "666posting Zodiac Sign Elements",
       subtitle = paste0("N = ",
                         sum(g_element$count),
                         " ; Chi-Square compared to population p-value = ",
                         format.pval(element_chisq$p.value, digits = 3)))
  
ggsave(filename = "outputs/horo-elements-666.png", width = hght, height = wdth)

```

## Hogwarts House

~~Data taken from https://drive.google.com/file/d/0B8PCmhQmtcDKLXlzSGtnZ0hKbjQ/view~~
Data taken from [Time Magazine](https://time.com/4921918/harry-potter-hogwarts-sorting-hat-quiz/), they don't have the actual percents posted, but a much larger sample size.

```{r}
#My best guess from eyeing The Times
house_percent <- c(.15, .30, .47, .08)
house <- c("Gryffindor", "Hufflepuff", "Ravenclaw", "Slytherin")
house_colors <- c("firebrick", "goldenrod3", "dodgerblue4", "darkgreen")
america_house <- data.frame(house, house_percent, stringsAsFactors = F) 
```

Replot the Times Data
```{r}
ggplot(america_house,
       aes(x = house, y = house_percent, fill = house)) +
  geom_col(color = "black") +
  scale_fill_manual(values = house_colors) + 
  scale_y_continuous(labels = scales::percent) +
  labs(title = "US Hogwarts House Distribution (Time Magazine's Data)",
       subtitle ="N = ~500,000")+
  xlab("Hogwarts Houses")

ggsave(filename = "outputs/hogwarts-gen-pop.png")


```

Preparing and cleaning Alex G data
```{r}
#Should turn this into a function by this point
house_dat <- as.data.frame(table(pers_dat$hp_house), stringsAsFactors = F) %>%
                filter(!(Var1 %in% c("",
                                     "Prefer not to answer",
                                     "I don't know"))) %>%
                rename(house = Var1, count = Freq) %>%
                mutate(house_percent = count/sum(count))

```

Chi-Square for houses
```{r}
#Sig difference
house_chisq <- chisq.test(house_dat$count, p = house_percent)
house_chisq
```

Plotting Alex G Hogwarts Houses
```{r}
###Plot house 
ggplot(house_dat,
       aes(x = house, y = count, fill = house)) +
  geom_col(color = "black") +
  scale_fill_manual(values = house_colors)  +
  xlab("Hogwarts Houses") +
  labs(title = "666posting Hogwarts Houses",
       subtitle = paste0("N = ",
                         sum(house_dat$count),
                         " ; Chi-Square compared to population p-value = ",
                         format.pval(house_chisq$p.value, digits = 3)))
  ggsave(filename = "outputs/hogwarts-666.png", width = hght, height = wdth)


```
This is interesting because if you look at the Time's article as people age Slytherin decreases and so I'd argue that because we have such a larger population of younger individuals is why Slytherin is so high. Which I'd further argue to say this WOULDN'T be significant if adjusted for age, but idk how to do that currently.



## Are there correlations betwen types?

Using Ztables from this [link](https://cran.r-project.org/web/packages/ztable/vignettes/heatmapTable.html)

Ztable signs vs MBTI
```{r results='asis'}

hor_mbt_dat <- pers_dat %>% filter(!(mbti %in% c("", "Prefer not to answer", "I don't know")),
                                   !(sign %in% c("", "Prefer not to answer", "I don't know"))) %>%
                mutate(element = case_when(
                  sign %in% c("Aries", "Leo", "Sagittarius") ~ "Fire",
                  sign %in% c("Gemini", "Libra", "Aquarius") ~ "Air",
                  sign %in% c("Taurus", "Virgo", "Capricorn") ~ "Earth",
                  sign %in% c("Cancer", "Scorpio", "Pisces") ~ "Water"
                  )
                )

#Sign
sign_tab <- table(hor_mbt_dat$mbti, hor_mbt_dat$sign)

sign_z <- ztable(sign_tab)

chi_sign_mbti <- chisq.test(hor_mbt_dat$mbti, hor_mbt_dat$sign, simulate.p.value = T)

#No way to format this nicely
sign_z %>% makeHeatmap() %>%
  print(caption = paste0("Heatmap Table of Zodiac Signs and Myer-Briggs Types; Chi-Sqare p-value of ", format.pval(chi_sign_mbti$p.value, digits = 3)))
```

Ztable Element vs MBTI
```{r results='asis'}
#Element
element_tab <- table(hor_mbt_dat$element, hor_mbt_dat$mbti)
element_z <- ztable(element_tab)

chi_element_mbti <- chisq.test(hor_mbt_dat$mbti, hor_mbt_dat$element, simulate.p.value = T)

element_z %>% makeHeatmap() %>%
  print(caption = paste0("Heatmap Table of Zodiac Elements and Myer-Briggs Types; Chi-Sqare p-value of ", format.pval(chi_element_mbti$p.value, digits = 3)))

```

Ztable for Zodiac and Houses
Remove names that repeat above (This hasn't been done)
```{r results='asis'}
hor_hp_dat <- pers_dat %>% filter(!(hp_house %in% c("", "Prefer not to answer", "I don't know")),
                                   !(sign %in% c("", "Prefer not to answer", "I don't know"))) %>%
                mutate(element = case_when(
                  sign %in% c("Aries", "Leo", "Sagittarius") ~ "Fire",
                  sign %in% c("Gemini", "Libra", "Aquarius") ~ "Air",
                  sign %in% c("Taurus", "Virgo", "Capricorn") ~ "Earth",
                  sign %in% c("Cancer", "Scorpio", "Pisces") ~ "Water"
                  )
                )
#Sign
sign_tab <- table(hor_hp_dat$hp_house, hor_hp_dat$sign)

sign_z <- ztable(sign_tab)

chi_sign_hp_house <- chisq.test(hor_hp_dat$hp_house, hor_hp_dat$sign, simulate.p.value = T)

#No way to format this nicely
sign_z %>% makeHeatmap() %>%
  print(caption = paste0("Heatmap Table of Zodiac Signs and Hogwarts Houses; Chi-Sqare p-value of ", format.pval(chi_sign_hp_house$p.value, digits = 3)))
```

Ztable for element and house
```{r results='asis'}
#Element
element_tab <- table(hor_hp_dat$hp_house, hor_hp_dat$element)
element_z <- ztable(element_tab)

chi_element_hp_house <- chisq.test(hor_hp_dat$hp_house, hor_hp_dat$element, simulate.p.value = T)

element_z %>% makeHeatmap() %>%
  print(caption = paste0("Heatmap Table of Zodiac Elements and Hogwarts Houses; Chi-Sqare p-value of ", format.pval(chi_element_hp_house$p.value, digits = 3)))
```

MBTI vs Houses
```{r results='asis'}
mbti_house_dat <- pers_dat %>% filter(!(mbti %in% c("", "Prefer not to answer", "I don't know")),
                                   !(hp_house %in% c("", "Prefer not to answer", "I don't know"))) 


#hp_house
hp_house_tab <- table(mbti_house_dat$mbti, mbti_house_dat$hp_house)

hp_house_z <- ztable(hp_house_tab)

chi_hp_house_mbti <- chisq.test(mbti_house_dat$mbti, mbti_house_dat$hp_house, simulate.p.value = T)

#No way to format this nicely
hp_house_z %>% makeHeatmap() %>%
  print(caption = paste0("Heatmap Table of Hogwarts Houses and Myer-Briggs Types; Chi-Sqare p-value of ", format.pval(chi_hp_house_mbti$p.value, digits = 3)))
```




## MBTI letters vs Zodiac Signs

Prepare data
```{r}
letter_dat <- pers_dat %>% filter(!(mbti %in% c("", "Prefer not to answer", "I don't know")),
                    !(sign %in% c("", "Prefer not to answer", "I don't know"))) %>%
              mutate(IE = ifelse(str_detect(mbti, "I"), "I", "E"),
                     SN = ifelse(str_detect(mbti, "S"), "S", "N"),
                     FT = ifelse(str_detect(mbti, "F"), "F", "T"),
                     JP = ifelse(str_detect(mbti, "J"), "J", "P"))  %>%
                mutate(element = case_when(
                  sign %in% c("Aries", "Leo", "Sagittarius") ~ "Fire",
                  sign %in% c("Gemini", "Libra", "Aquarius") ~ "Air",
                  sign %in% c("Taurus", "Virgo", "Capricorn") ~ "Earth",
                  sign %in% c("Cancer", "Scorpio", "Pisces") ~ "Water"
                  )
                )
```


Making sign table function
```{r}

col1 <- "FT"
col2 <- "sign"
title <- "Heatmap Table of Zodiac Signs and Intro vs Extra"
simul_p <- F
pval_digits <- 3



auto_ztable <- function(df, col1, col2, title, simul_p = F, pval_digits = 3) {
  temp_tab <- table(df[[col1]], df[[col2]])
  temp_ztab <- ztable(temp_tab)
  chi_result <- chisq.test(df[[col1]], df[[col2]], simulate.p.value = simul_p)
  temp_ztab %>% makeHeatmap() %>%
  print(caption = paste0(title," ; Chi-Sqare p-value of ", format.pval(chi_result$p.value, digits = pval_digits)))
}

# #Sign IE
# IE_sign_tab <- table(letter_dat$IE, letter_dat$sign)
# 
# IE_sign_z <- ztable(IE_sign_tab)
# 
# chi_sign_IE <- chisq.test(letter_dat$IE, letter_dat$sign, simulate.p.value = T)
# 
# #No way to format this nicely
# IE_sign_z %>% makeHeatmap() %>%
#   print(caption = paste0("Heatmap Table of Zodiac Signs and Intro vs Extra; Chi-Sqare p-value of ", format.pval(chi_sign_IE$p.value, digits = 3)))

```


Sign and IE
```{r results='asis'}
#Sign IE

auto_ztable(letter_dat,
            "IE",
            "sign",
            "Heatmap Table oF Zodiac Signs and Intro vs Extra",
            simul_p = T)
```

Sign and SN
```{r results='asis'}

#Sign SN
auto_ztable(letter_dat,
            "SN",
            "sign",
            "Heatmap Table oF Zodiac Signs and Intro vs Extra",
            simul_p = T)
```

Sign and FT
```{r results='asis'}
#Sign FT
auto_ztable(letter_dat,
            "FT",
            "sign",
            "Heatmap Table oF Zodiac Signs and Intro vs Extra",
            simul_p = T)
```

Sign and JP
```{r results='asis'}
#Sign JP
auto_ztable(letter_dat,
            "JP",
            "sign",
            "Heatmap Table of Zodiac Signs and Judge vs Perceive",
            simul_p = T)


```

## MBTI letters vs Zodiac Elements

Element EI
```{r results='asis'}

auto_ztable(letter_dat,
            "IE",
            "element",
            "Heatmap Table oF Zodiac Elements and Intro vs Extra",
            simul_p = T)
```

Element SN
```{r results='asis'}
auto_ztable(letter_dat,
            "SN",
            "element",
            "Heatmap Table oF Zodiac Elements and Intro vs Extra",
            simul_p = T)
```

Element FT
```{r results='asis'}

auto_ztable(letter_dat,
            "FT",
            "element",
            "Heatmap Table oF Zodiac Elements and Intro vs Extra",
            simul_p = T)
```


Element JP
```{r results='asis'}

auto_ztable(letter_dat,
            "JP",
            "element",
            "Heatmap Table of Zodiac Elements and Judge vs Perceive",
            simul_p = T)

```

## Hogwarts MBTI Letter Analysis

Prepare data
```{r results='asis'}
letter_dat_hp <- pers_dat %>% filter(!(mbti %in% c("", "Prefer not to answer", "I don't know")),
                    !(hp_house %in% c("", "Prefer not to answer", "I don't know"))) %>%
              mutate(IE = ifelse(str_detect(mbti, "I"), "I", "E"),
                     SN = ifelse(str_detect(mbti, "S"), "S", "N"),
                     FT = ifelse(str_detect(mbti, "F"), "F", "T"),
                     JP = ifelse(str_detect(mbti, "J"), "J", "P"))
```

House IE
```{r results='asis'}
auto_ztable(letter_dat_hp,
            "IE",
            "hp_house",
            "Heatmap Table of Hogwarts Houses and Intro vs Extra",
            simul_p = T)
```

House SN
```{r results='asis'}

auto_ztable(letter_dat_hp,
            "SN",
            "hp_house",
            "Heatmap Table of Hogwarts Houses and Intro vs Extra",
            simul_p = T)
```

House FT
```{r results='asis'}

auto_ztable(letter_dat_hp,
            "FT",
            "hp_house",
            "Heatmap Table of Hogwarts Houses and Intro vs Extra",
            simul_p = T)

```

House JP
```{r results='asis'}
auto_ztable(letter_dat_hp,
          "JP",
          "hp_house",
          "Heatmap Table of Hogwarts Houses and Judge vs Perceive",
          simul_p = T)
  
```
#Habits

## Substance Usage
```{r}
options(ztable.type = "viewer")
dat_habits <- dat %>%
          select(id, age, gender, weed_use, alc_use, concerts) %>%
          mutate(weed_use = case_when(
                    weed_use == "I used to smoke weed, but now I don't" ~ "I don't smoke weed anymore",
                    T ~ weed_use
                  ),
                 alc_use = case_when(
                    alc_use == "I used to drink, but don't anymore" ~ "I don't drink anymore",
                    T ~ alc_use
                 ))


dat_drugs <- dat_habits  %>% filter(alc_use != "", weed_use != "")


auto_ztable(dat_drugs,
          "alc_use",
          "weed_use",
          "Heatmap Table of Alcohol and Weed Usage",
          simul_p = T)

#Make a histogram of ages and habits
dat_drugs$alc_use <- factor(dat_drugs$alc_use, names(sort(table(dat_drugs$alc_use), decreasing= F)))
ggplot(dat_drugs, aes(x=age, fill=alc_use)) +
  geom_histogram(breaks=seq(15, 45, by=1), color="black")

dat_drugs$weed_use <- factor(dat_drugs$weed_use, names(sort(table(dat_drugs$weed_use), decreasing= F)))
ggplot(dat_drugs, aes(x=age, fill=weed_use)) +
  geom_histogram(breaks=seq(15, 45, by=1), color="black")

#Simple barplot

dat_drugs$alc_use <- factor(dat_drugs$alc_use, c("I never had alcohol",
                                                 "I don't drink anymore",
                                                 "Once a month/socially",
                                                 "Once a week",
                                                 "Multiple times per week",
                                                 "Every day",
                                                 "Multiple times a day"))

ggplot(dat_drugs, aes(x=alc_use, fill=alc_use)) +
  geom_bar(color="black") + coord_flip()

dat_drugs$weed_use <- factor(dat_drugs$weed_use, c("I have never smoked weed",
                                                 "I don't smoke weed anymore",
                                                 "Once a month",
                                                 "Once a week",
                                                 "Multiple times per week",
                                                 "Every day",
                                                 "Multiple times a day"))

ggplot(dat_drugs, aes(x=weed_use, fill=weed_use)) +
  geom_bar(color="black") + coord_flip()
```





# The most average Alex G person
```{r}
library(lubridate)
#When the average person filled out the survey
mean(mdy_hm(dat$Timestamp))
#Average age
avg_age <- mean(dat$age)
#They live in the US
avg_country <- names(sort(table(dat$country),decreasing=TRUE)[1])
#In California
avg_state <- names(sort(table(dat$state),decreasing=TRUE)[3])
# They are white
avg_race <- names(sort(table(dat$race),decreasing=TRUE)[1])
#They are male
avg_gender <- names(sort(table(dat$gender),decreasing=TRUE)[1])
#They are cis
avg_identity <- names(sort(table(dat$transgender),decreasing=TRUE)[1])
#They are straight
avg_orientation <- names(sort(table(dat$orientation),decreasing=TRUE)[1])
#They are monogomous
avg_poly <- names(sort(table(dat$polyamorous),decreasing=TRUE)[1])
#They started listening to alex G at the age of 19
avg_start_listen <- median(dat$first_age)
#They've been to 2 Alex G concerts
avg_alex_conc <- median(dat$alex_g_concerts, na.rm = T)
# They found Alex G through a friend
avg_discovery <- names(sort(table(dat$discover_method),decreasing=TRUE)[1])
#Their favorite song is Snot
avg_fave_song <- names(sort(table(dat$favorite_son),decreasing=TRUE)[1:3])
#Their favorite album is Trick
avg_fave_album <- names(sort(table(dat$favorite_album),decreasing=TRUE)[1])
#They don't listen to Alex G's unreleased albums
avg_unreleased <- names(sort(table(dat$unreleased_album),decreasing=TRUE)[1])
#They like the gretel music video
avg_music_vid <- names(sort(table(dat$music_vid),decreasing=TRUE)[1])
#They listen to music via spotify
avg_music_source <- names(sort(table(dat$music_method),decreasing=TRUE)[1:3])
#They probably play guitar
avg_instrument <- (sum_instr %>% arrange(desc(Freq)))[1,1]
#They are not in a band
avg_band <- sort(table(dat$in_band),decreasing=TRUE)[1:3]
####NEED TO DO ART
#
```



```{r echo=F}
#####UNUSED CODE


# ####################
# world_2 <-as.data.frame(world)
# 
# new_map <- joinCountryData2Map(world_2, joinCode = "ISO2", nameJoinColumn = "iso_a2", resolution = "high")
# new_map_poly <- fortify(new_map)
# new_map_poly <- merge(new_map_poly, new_map@data, by.x="id", by.y="ADMIN", all.x=T)
# new_map_poly <- new_map_poly %>% arrange(id, order)

# 
# ###Higher res world
# new_map_poly <- fortify(worldmap)
# new_map_poly <- merge(new_map_poly, new_map@data, by.x="id", by.y="ADMIN", all.x=T)
# #new_map_poly <- new_map_poly %>% arrange(id, order)

# ###Unreleased word cloud
# unreleased <- songs_dat %>% filter(unreleased_album != "I don't listen to them.") 
# unreleased_tally <- data.frame(table(unreleased$unreleased_album), stringsAsFactors = F)
# 
# songs_dat <- songs_dat %>%
#   mutate(unreleased_album = ifelse(unreleased_album %in% "I don't listen to them.", "Don't listen", unreleased_album))
# 
# not_listen_tally <- data.frame(table(songs_dat$unreleased_album), stringsAsFactors = F)
# 
# set.seed(1234)
# wordcloud(words = not_listen_tally$Var1, freq = not_listen_tally$Freq, min.freq = 1,
#           max.words=200, random.order=FALSE, rot.per=0.35, 
#           colors=brewer.pal(8, "Dark2"))



# #############
# pol_count <- as.data.frame(table(poltical_dat$left_right, poltical_dat$lib_auth))
# colnames(pol_count)[1:2] <- c("left_right", "lib_auth")
# pol_count$left_right <-factor(pol_count$left_right, levels = c("0","1", "2", "3", "4", "5", "6", "7", "8", "9","10"))
# #pol_count$lib_auth <- as.integer(as.character(pol_count$lib_auth))
# 
# ggplot(pol_count) +
#           geom_point(aes(x = left_right, y = lib_auth, size= Freq)) +
#           #  
#             geom_rect(aes(xmin = '5', xmax= '10',ymin = '0', ymax='5'), fill = "yellow", alpha = 0.005) +
#              geom_rect(aes(xmin = '0', xmax= '5',ymin = '0', ymax='5'), fill = "green", alpha = 0.005) +
#              geom_rect(aes(xmin = '5', xmax= '10',ymin = '5', ymax='10'), fill = "blue", alpha = 0.005) +
#             geom_rect(aes(xmin = "0", xmax= "5",ymin = "5", ymax="10"), fill = "red", alpha = 0.005) + 
#            
#            #Adding median and mean
#           # geom_point(aes(x=med_LR, y=med_LA), colour="white", shape = 9, size =2) +
#            #geom_point(aes(x=mean_LR, y=mean_LA), colour="red", shape = 9, size =2) +
#           labs(title = "666posting Political Compass", subtitle = paste0("N = ", nrow(poltical_dat))) + 
#    ylab("libertarian to authoritarian") +
#                xlab("left to right") +
#     
#               coord_fixed() #+ theme_void()
```


# [Things to Do](https://sandy.bandcamp.com/track/things-to-do)

  - Turn repetitive code into functions for example in the personality block
  - Add Alex G Habits